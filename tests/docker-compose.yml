version: "3.8"
name: toolkit-test

services:

  postgres:
    image: postgres
    env_file:
      - ./.env
    ports:
      - '5432:5432'
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -d ${POSTGRES_DB} -U ${POSTGRES_USER}" ]

  redis:
    image: redis/redis-stack:latest
    ports:
      - "6379:6379"


  backend:
    build:
      context: ../backend
      dockerfile: ./web.Dockerfile
    env_file:
      - ./.env
    environment:
      POSTGRES_HOST: postgres
      REDIS_HOST: redis

    depends_on:
      redis:
        condition: service_started
      postgres:
        condition: service_healthy

    container_name: backend

  service_calendar:
    build:
      context: ../backend
      dockerfile: ./calendar.Dockerfile
    env_file:
      - ./.env
    environment:
      POSTGRES_HOST: postgres
      REDIS_HOST: redis

    depends_on:
      redis:
        condition: service_started
      postgres:
        condition: service_healthy

    container_name: service_calendar


  tests:
    build:
      context: ..
      dockerfile: tests/Dockerfile
    command: >
      sleep infinity

    environment:
      POSTGRES_HOST: postgres
      REDIS_HOST: redis


    depends_on:
      - backend
      - service_calendar

    env_file:
      - ./.env


